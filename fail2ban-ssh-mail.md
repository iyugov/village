# Настройка отправки уведомлений о блокировках доступа по SSH через локальный почтовый сервер

## Описание

Настраивается отправка уведомлений о блокировках службой fail2ban доступа к хосту по SSH через локальный почтовый сервер на почтовый ящик локального пользователя.

## Требования

* [Настройка fail2ban для сервера SSH](fail2ban-ssh.md)
* Клиент SSH, имеющий сетевой доступ к серверу.

## Параметры

* `HOSTNAME` - сетевое имя хоста.

## Выполнение

1. На хосте, который настраивается, установим пакеты `postfix` и `mailutils`:

    ```sh
    sudo apt update
    sudo apt install postfix mailutils
    ```

2. При установке в окне настройки Postfix выберем "Local only", укажем иия системы - `HOSTNAME`.

3. Проверим состояние службы Postfix:

    ```sh
    sudo systemctl status postfix
    ```

4. Выполним отправку тестового сообщения:

    ```sh
    echo "Тестовое сообщение" | mail -s "Тестовая тема" user@HOSTNAME
    ```

5. Проверим получение локальной почты:

    ```sh
    mail
    ```

    В отображённом списке сообщений должно быть сообщение с тестовой темой. На запрос `?` нажмём `Enter`. Откроется само сообщение. Нажмём `q` для выхода из программы просмотра почты. При выходе сообщение удаляется из входящей почты и сохраняется в файле `mbox` в домашнем каталоге пользователя.  

6. *Для более удобного управления сообщениями можно установить программу `mutt`*:

    ```sh
    sudo apt install mutt
    ```

7. Откроем файл локальной конфигурации:

    ```sh
    sudo vim /etc/fail2ban/jail.local
    ```

8. Добавим в секцию `[sshd]` следующие строки:

    ```config
    destemail = user@HOSTNAME
    sender = fail2ban@HOSTNAME
    mta = mail
    action = %(action_mwl)s
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

9. Перезапустим службу *fail2ban*:

    ```sh
    sudo systemctl restart fail2ban
    ```

10. Проверим работу *fail2ban*: спровоцируем блокировку при серии подключений с клиента с неправильными учётными данными и проверим локальную почту на сервере. В почте должно быть сообщение о блокировке. Также уведомления будут отправляться о запуске и завершении работы *fail2ban*.