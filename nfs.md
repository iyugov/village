# Создание сервера NFS

## Описание

Создаётся сервер NFS на базе Ubuntu Server 24.04 с RAID 1. Сервер имеет адрес 10.0.1.11/24.
Обеспечиваются базовые параметры безопасности.
Настраивается общий каталог `share` по NFS с автоматическим монтированием.

## Требования

* [Создание сервера имён](ns.md)
* [Создание коммутатора серверов баз данных](db-server-switch.md)
* [Создание хоста консольного клиента](client-cli.md)

## Выполнение

### Создание хоста

1. Создадим виртуальную машину VirtualBox со следующими параметрами:
    * имя - "NFS";
    * ОС - Linux, Ubuntu (64-bit);
    * объём оперативной памяти - 2048 Мб, процессоры - 1;
    * накопители:
    * SATA, 2 Гб;
    * SATA, 20 2б;
    * SATA, 20 2б.
    * оптический привод для установочного образа;
    * сетевой адаптер: имеет тип Generic Driver с именем UDPTunnel.

2. Добавим виртуальную машину в GNS3 через шаблон.

3. Установим управление GNS3 для сетевых интерфейсов приложения и зададим число сетевых адаптеров - 1.

4. Подключим сетевой интерфейс `Ethernet0` виртуальной машины к порту `Ethernet7` коммутатора "ServerSwitch".

5. Загрузим виртуальную машину с установочного образа Ubuntu Server 24.04.1 LTS.

6. В меню загрузки выберем "Try or Install Ubuntu Server" и дождёмся окончания загрузки.

7. Выберем язык "English". Выберем раскладку клавиатуры "Russian" и вариант "Russian". Определим клавишу "Caps Lock" для переключения раскладок.

8. Выберем вариант установки "Ubuntu Server".

9. Для сетевого интерфейса укажем настройки для IPv4 вручную:
    * подсеть - 10.0.1.0/24;
    * адрес - 10.0.1.11;
    * шлюз - 10.0.1.1;
    * сервер имён - 10.0.1.3;
    * домен поиска - "village".

10. Оставим настройку прокси пустой.

11. Для разметки накопителей выберем "Custom storage layout".

12. Создадим RAID 1:
    * выберем "Create software RAID (md)";
    * укажем имя "md0" и уровень 1 (зеркальный);
    * отметим устройства - 2 накопителя по 20 Гб.

13. Создадим LVM:
    * выберем "Create volume group (LVM)";
    * укажем имя "vg0" и расположение - "md0".

14. Сделаем накопитель размером 2 Гб загрузочным ("Use As Boot Device"). В свободном пространстве этого накопителя создадим раздел GPT ("Add GPT Partition") с размером по умолчанию, файловой системой ext4 и точкой монтирования "/boot".

15. В свободном пространстве группы логических томов "vg0" создадим логический том ("Create Logical Volume") с именем "lv-0", размером по умолчанию, файловой системой ext4 и точкой монтирования "/".

16. Проверим разметку, завершим её, согласимся на изменения.

17. Зададим отображаемое имя пользователя "User", имя сервера "nfs", имя пользователя "user"; зададим пароль пользователя.

18. Пропустим настройку Ubuntu Pro.

19. Отметим установку сервера OpenSSH.

20. Дождёмся окончания установки. Перезагрузим сервер. Авторизуемся.

21. Обновим пакеты:

    ```sh
    sudo apt update
    sudo apt upgrade
    sudo apt dist-upgrade
    ```

#### Добавление записей на сервер имён

1. На сервере "NS" откроем файл локальной прямой зоны:

    ```sh
    sudo vim /etc/bind/db.village
    ```

2. Добавим в файл следующую строку:

    ```config
    nfs     IN      A       10.0.1.11
    ```

    Увеличим значение параметра `Serial` на 1.
    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

3. Проверим конфигурацию зоны:

    ```sh
    sudo named-checkzone village /etc/bind/db.village
    ```

4. На сервере "NS" откроем файл локальной обратной зоны:

    ```sh
    sudo vim /etc/bind/db.10.0.1
    ```

5. Добавим в файл следующую строку:

    ```config
    11      IN     PTR    nfs.village.
    ```

    Увеличим значение параметра `Serial` на 1.
    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

6. Проверим конфигурацию зоны:

    ```sh
    sudo named-checkzone 1.0.10.in-addr.arpa /etc/bind/db.10.0.1
    ```

7. Перезапустим *bind*:

    ```sh
    sudo systemctl restart bind9
    ```

### Настройка безопасности сервера

#### Настройка доступа на сервер по ключу

1. На сервере "NFS" откроем файл настроек сервера SSH:

    ```sh
    sudo vim /etc/ssh/sshd_config.d/50-cloud-init.conf
    ```

2. Установим следующие значения параметров:

    ```config
    PermitRootLogin no
    StrictModes yes
    MaxAuthTries 6
    PubkeyAuthentication yes
    PasswordAuthentication yes
    AllowUsers user
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

3. Перезапустим сервер SSH:

    ```sh
    sudo systemctl restart ssh
    ```

4. Установим правило межсетевого экрана для OpenSSH:

    ```sh
    sudo ufw allow OpenSSH
    ```

5. Включим межсетевой экран:

    ```sh
    sudo ufw enable
    ```

6. На сервере "Access" сгеренируем ключ:

    ```sh
    ssh-keygen -t ed25519 -C "admin@village"
    ```

    Укажем путь и имя файла для сохранения ключа, например, `/home/user/.ssh/id_nfs`.
    Зададим пустой пароль.

7. Выполним копирование сгенерированного ключа на целевой сервер:

    ```sh
    ssh-copy-id -i ~/.ssh/id_nfs user@nfs
    ```

8. Выполним вход по ключу:

    ```sh
    ssh -i ~/.ssh/id_nfs user@nfs
    ```

    Авторизация должна пройти без запроса пароля.  

9. На сервере "NFS" откроем файл настроек сервера SSH:

    ```sh
    sudo vim /etc/ssh/sshd_config.d/50-cloud-init.conf
    ```

10. Выключим авторизацию по паролю:

    ```config
    PasswordAuthentication no
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

11. Перезапустим сервер SSH:

    ```sh
    sudo systemctl restart ssh
    ```

12. На сервере "Access" создадим и откроем файл настроек подключений по SSH:

    ```sh
    vim ~/.ssh/config
    ```

    Добавим в файл следующий раздел:

    ```config
    Host nfs
      Hostname nfs
      Port 22
      IdentityFile ~/.ssh/id_nfs
      IdentitiesOnly yes
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

13. Выполним вход на сервер с учётом настроек:

    ```sh
    ssh nfs
    ```

    Авторизация должна пройти автоматически.

14. В настройках хоста "NFS" в GNS3 установим флажок "Start VM in headless mode", остановим и запустим хост.

15. Настроим fail2ban:
    * Указания: [Настройка fail2ban для сервера SSH](fail2ban-ssh.md)

16. Настроим отправку локальных уведомлений о блокировках доступа:
    * Указания: [Настройка отправки уведомлений о блокировках доступа по SSH через локальный почтовый сервер](fail2ban-ssh-mail.md)
    * Параметры:
        * `HOSTNAME`: `nfs`

### Настройка сервера NFS

1. Установим пакеты сервера и общих компонентов NFS:

    ```sh
    sudo apt install nfs-kernel-server nfs-common
    ```

2. Создадим экспортируемый каталог для NFS и установим текущего пользователя его владельцем:

    ```sh
    sudo mkdir -p /srv/nfs/share
    sudo chown -R ${USER}:${USER} /srv/nfs/share
    ```

3. Откроем файл экспортируемых каталогов NFS:

    ```sh
    sudo vim /etc/exports
    ```

4. Добавим в файл строку описания экспортируемого каталога:

    ```config
    /srv/nfs/share 172.16.0.101/16(rw,sync,no_subtree_check)
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

5. Применим настройки экспорта каталогов:

    ```sh
    sudo exportfs -a
    ```

6. Перезапустим службу NFS:

    ```sh
    sudo systemctl restart nfs-kernel-server
    ```

7. Проверим настройки экспортируемого каталога:

    ```sh
    showmount -e localhost
    ```

    Должна отобразиться строка с данными проэкспортированного каталога.

8. Установим правило межсетевого экрана для Samba:

    ```sh
    sudo ufw allow nfs
    ```

### Настройка клиента NFS

1. На хосте "Client1" установим пакет с общими компонентами NFS:

    ```sh
    sudo apt install nfs-common
    ```

2. Создадим каталог для монтирования общего каталога и установим текущему пользователю права на него:

    ```sh
    sudo mkdir -p /mnt/nfs/share
    sudo chown ${USER}:${USER} -R /mnt/nfs/share
    ```

### Проверка монтирования и настройка автоматического монтирования

1. На хосте "NFS" создадим тестовый файл в общем каталоге:

    ```sh
    sudo touch /srv/nfs/share/test
    ```

2. На хосте "Client1" Смонтируем каталог NFS:

    ```sh
    sudo mount -t nfs nfs:/srv/nfs/share /mnt/nfs/share
    ```

3. На хосте "Client 1" перейдём в локальный каталог, куда должен монтироваться общий каталог:

    ```sh
    cd /mnt/nfs/share
    ls
    ```

    Должно быть выведено имя файла `test`.

4. Откроем файл `fstab`:

    ```sh
    sudo vim /etc/fstab
    ```

    Добавим в файл строку монтирования каталога:

    ```config
    nfs:/srv/nfs/share /mnt/nfs/share nfs defaults 0 0
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

5. Перезагрузим клиента, проверим автоматическое монтирование:

    ```sh
    cd /mnt/nfs/share
    ls
    ```

    Должно быть выведено имя файла `test`.
