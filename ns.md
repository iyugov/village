# Создание сервера имён

## Описание

Создаётся сервер имён на базе Ubuntu Server 24.04 с RAID 1. Сервер имеет адрес 10.0.1.3/24. Сервер имён для самого этого сервера (вышестоящий) имеет адрес 192.168.1.1 в сети базовой системы.

## Требования

* [Создание сервера доступа](access.md)

## Выполнение

### Создание хоста

1. Создадим виртуальную машину VirtualBox со следующими параметрами:

    * имя - "NS";
    * ОС - Linux, Ubuntu (64-bit);
    * объём оперативной памяти - 2048 Мб, процессоры - 1;
    * накопители:
        * SATA, 2 Гб;
        * SATA, 10 Гб;
        * SATA, 10 Гб.
    * оптический привод для установочного образа;
    * сетевой адаптер: имеет тип Generic Driver с именем UDPTunnel.

2. Добавим виртуальную машину в GNS3 через шаблон.

3. Установим управление GNS3 для сетевых интерфейсов приложения и зададим число сетевых адаптеров - 1.

4. Подключим сетевой интерфейс `Ethernet0` виртуальной машины к порту `Ethernet2` коммутатора "ServerSwitch".

5. Загрузим виртуальную машину с установочного образа Ubuntu Server 24.04.1 LTS.

6. В меню загрузки выберем "Try or Install Ubuntu Server" и дождёмся окончания загрузки.
    * Выберем язык "English". Выберем раскладку клавиатуры "Russian" и вариант "Russian". Определим клавишу "Caps Lock" для переключения раскладок.
    * Выберем вариант установки "Ubuntu Server".
    * Для сетевого интерфейса укажем настройки для IPv4 вручную:
        * подсеть - 10.0.1.0/24;
        * адрес - 10.0.1.3;
        * шлюз - 10.0.1.1;
        * сервер имён - 192.168.1.1 (в сети базовой системы).

7. Оставим настройку прокси пустой.

8. Для разметки накопителей выберем "Custom storage layout".

9. Создадим RAID 1:
    * выберем "Create software RAID (md)";
    * укажем имя "md0" и уровень 1 (зеркальный);
    * отметим устройства - 2 накопителя по 10 Гб.

10. Создадим LVM:
    * выберем "Create volume group (LVM)";
    * укажем имя "vg0" и расположение - "md0".

11. Сделаем накопитель размером 2 Гб загрузочным ("Use As Boot Device"). В свободном пространстве этого накопителя создадим раздел GPT ("Add GPT Partition") с размером по умолчанию, файловой системой ext4 и точкой монтирования "/boot".

12. В свободном пространстве группы логических томов "vg0" создадим логический том ("Create Logical Volume") с именем "lv-0", размером по умолчанию, файловой системой ext4 и точкой монтирования "/".

13. Проверим разметку, завершим её, согласимся на изменения.

14. Зададим отображаемое имя пользователя "User", имя сервера "ns", имя пользователя "user"; зададим пароль пользователя.

15. Пропустим настройку Ubuntu Pro.

16. Отметим установку сервера OpenSSH.

17. Дождёмся окончания установки. Перезагрузим сервер. Авторизуемся.

18. Обновим пакеты:

    ```sh
    sudo apt update
    sudo apt upgrade
    sudo apt dist-upgrade
    ```

### Настройка безопасности сервера имён

#### Настройка доступа на сервер имён по ключу

1. На сервере имён откроем файл настроек сервера SSH:

    ```sh
    sudo vim /etc/ssh/sshd_config.d/50-cloud-init.conf
    ```

2. Установим следующие значения параметров:

    ```config
    PermitRootLogin no
    StrictModes yes
    MaxAuthTries 6
    PubkeyAuthentication yes
    PasswordAuthentication yes
    AllowUsers user
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).  
3. Перезапустим сервер SSH:

    ```sh
    sudo systemctl restart ssh
    ```

4. Установим правило межсетевого экрана для OpenSSH:

    ```sh
    sudo ufw allow OpenSSH
    ```

5. Включим межсетевой экран:

    ```sh
    sudo ufw enable
    ```

6. На сервере "access" сгеренируем ключ:

    ```sh
    ssh-keygen -t ed25519 -C "admin@village"
    ```

    Укажем путь и имя файла для сохранения ключа, например, `/home/user/.ssh/id_ns`.  
    Зададим пустой пароль.

7. Выполним копирование сгенерированного ключа на сервер баз данных:

    ```sh
    ssh-copy-id -i ~/.ssh/id_ns user@10.0.1.3
    ```

8. Выполним вход по ключу:

    ```sh
    ssh -i ~/.ssh/id_ns user@10.0.1.3
    ```

    Авторизация должна пройти без запроса пароля.

9. На сервере имён откроем файл настроек сервера SSH:

    ```sh
    sudo vim /etc/ssh/sshd_config.d/50-cloud-init.conf
    ```

10. Выключим авторизацию по паролю:

    ```config
    PasswordAuthentication no
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).  
11. Перезапустим сервер SSH:

    ```sh
    sudo systemctl restart ssh
    ```

12. На сервере "access" откроем файл настроек подключений по SSH:

    ```sh
    vim ~/.ssh/config
    ```

    Добавим в файл следующие строки:  

    ```config
    Host ns
    Hostname 10.0.1.3
    Port 22
    IdentityFile ~/.ssh/id_ns
    IdentitiesOnly yes
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

13. Выполним вход на сервер имён с учётом настроек:

    ```sh
    ssh ns
    ```

    Авторизация должна пройти автоматически.

14. В настройках хоста "NS" в GNS3 установим флажок "Start VM in headless mode", остановим и запустим хост.

#### Настройка fail2ban на сервере имён

1. На сервере имён установим *fail2ban*:

    ```sh
    sudo apt update
    sudo apt install fail2ban
    ```

2. Создадим файл локальной конфигурации копированием имеющегося:

    ```sh
    sudo cp /etc/fail2ban/jail.{conf,local}
    ```

3. Откроем файл локальной конфигурации:

    ```sh
    sudo vim /etc/fail2ban/jail.local
    ```

4. Приведём файл к следующему виду:

    ```config
    [sshd]
    enabled = true
    port = 22
    logpath = %(sshd_log)s
    backend = %(sshd_backend)s
    maxretry = 3
    findtime = 10m
    bantime = 30m
    bantime.increment = true
    bantime.ratio = 1
    bantime.factor = 2
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

5. Перезапустим службу *fail2ban*:

    ```sh
    sudo systemctl restart fail2ban
    ```

6. Проверим работу *fail2ban* по блокировке неверных авторизаций.

#### Настройка отправки уведомлений о блокировках доступа на сервер имён через локальный почтовый сервер

1. На сервере имён установим пакеты `postfix` и `mailutils`:

    ```sh
    sudo apt update
    sudo apt install postfix mailutils
    ```

2. При установке в окне настройки Postfix выберем "Local only", укажем иия системы - `ns`.

3. Проверим состояние службы Postfix:

    ```sh
    sudo systemctl status postfix
    ```

4. Выполним отправку тестового сообщения:

    ```sh
    echo "Тестовое сообщение" | mail -s "Тестовая тема" user@ns
    ```

5. Проверим получение локальной почты:

    ```sh
    mail
    ```

    В отображённом списке сообщений должно быть сообщение с тестовой темой. На запрос `?` нажмём `Enter`. Откроется само сообщение. Нажмём `q` для выхода из программы просмотра почты. При выходе сообщение удаляется из входящей почты и сохраняется в файле `mbox` в домашнем каталоге пользователя.  

6. *Для более удобного управления сообщениями можно установить программу `mutt`*:

    ```sh
    sudo apt install mutt
    ```

7. Откроем файл локальной конфигурации:

    ```sh
    sudo vim /etc/fail2ban/jail.local
    ```

8. Добавим в секцию `[sshd]` следующие строки:

    ```config
    destemail = user@ns
    sender = fail2ban@ns
    mta = mail
    action = %(action_mwl)s
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

9. Перезапустим службу *fail2ban*:

    ```sh
    sudo systemctl restart fail2ban
    ```

10. Проверим отправку сообщений при блокировке. Также уведомления будут отправляться о запуске и завершении работы *fail2ban*.

### Настройка сервера имён

#### Базовая настройка

1. Установим пакет сервера DNS:

    ```sh
    sudo apt install bind9
    ```

2. Откроем файл настроек сервера:

    ```sh
    sudo vim /etc/bind/named.conf.options
    ```

    В конце основного раздела, перед финальной закрывающей фигурной скобкой добавим настройку перенаправления запроса на сервер имён в сети базовой системы (здесь - 192.168.1.1) и список клиентов, которым разрешены запросы:  

    ```config
        forwarders {
            192.168.1.1;
        };
        
        allow-query {
            localhost;
            10.0.1.0/24;
            172.16.0.0/24;
        };
    
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

3. Перезапустим службу сервера:

    ```sh
    sudo systemctl restart bind9
    ```

4. Установим правила межсетевого экрана для сервера имён:

    ```sh
    sudo ufw allow 53/udp
    sudo ufw allow 53/tcp
    ```

#### Настройка зон просмотра

1. Откроем файл локальной конфигурации сервера имён:

    ```sh
    sudo vim /etc/bind/named.conf.local
    ```

2. Добавим в файл данные о прямой и обратной зонах:

    ```config
    zone "village" {
        type master;
        file "/etc/bind/db.village";
    };
    
    zone "1.0.10.in-addr.arpa" {
        type master;
        file "/etc/bind/db.10.0.1";
    };
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

3. Скопируем файл настроек по умолчанию для прямой зоны:

    ```sh
    sudo cp /etc/bind/db.{local,village}
    ```

4. Откроем файл локальной прямой зоны:

    ```sh
    sudo vim /etc/bind/db.village
    ```

5. Приведём содержимое файла к следующему виду:

    ```config
    $TTL    604800
    @       IN      SOA     ns.village root.village (
                                2         ; Serial
                            604800         ; Refresh
                            86400         ; Retry
                            2419200         ; Expire
                            604800 )       ; Negative Cache TTL
    ;
    @       IN      NS      ns.village.
    @       IN      A       10.0.1.3
    @       IN      AAAA    ::1
    access  IN      A       10.0.1.2
    ns      IN      A       10.0.1.3
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

6. Проверим конфигурацию зоны:

    ```sh
    sudo named-checkzone village /etc/bind/db.village
    ```

7. Скопируем файл настроек по умолчанию для обратной зоны:

    ```sh
    sudo cp /etc/bind/db.{127,10.0.1}
    ```

8. Откроем файл локальной обратной зоны:

    ```sh
    sudo vim /etc/bind/db.10.0.1
    ```

9. Приведём содержимое файла к следующему виду:

    ```config
    $TTL    604800
    @       IN      SOA     ns.village. root.village. (
                                1         ; Serial
                            604800         ; Refresh
                            86400         ; Retry
                            2419200         ; Expire
                            604800 )       ; Negative Cache TTL
    ;
    @       IN      NS      ns.village.
    2       IN     PTR    access.village.
    3       IN     PTR    ns.village.
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

10. Проверим конфигурацию зоны:

    ```sh
    sudo named-checkzone 1.0.10.in-addr.arpa /etc/bind/db.10.0.1
    ```

11. Перезапустим *bind*:

    ```sh
    sudo systemctl restart bind9
    ```

### Перенастройка серверов на сервер имён

#### Перенастройка сервера "Access" на сервер имён

1. На сервере "Access" откроем файл конфигурации *netplan*:

    ```sh
    sudo vim /etc/netplan/50-cloud-init.yaml
    ```

2. В разделе `nameservers` для имеющегося сетевого интерфейса изменим адрес сервера имён на 10.0.1.3:

    ```config
    addresses:
    - 10.0.1.3
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).  

3. Применим настройки *netplan*:

    ```sh
    sudo netplan apply
    ```

4. Проверим разрешение имён с помощью `nslookup`.

5. Откроем файл настроек подключений по SSH:

    ```sh
    vim ~/.ssh/config
    ```

    В файле заменим IP-адреса серверов их именами:  

    ```config
    Host ns
      Hostname ns.village
      Port 22
      IdentityFile ~/.ssh/id_ns
      IdentitiesOnly yes
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

6. Проверим подключения (`ssh ns`).

#### Перенастройка сервера "NS" на себя в качестве сервера имён

1. На сервере "NS" откроем файл конфигурации *netplan*:

    ```sh
    sudo vim /etc/netplan/50-cloud-init.yaml
    ```

2. В разделе `nameservers` для имеющегося сетевого интерфейса изменим адрес сервера имён на 10.0.1.3 (собственный адрес):

    ```config
    addresses:
    - 10.0.1.3
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

3. Применим настройки *netplan*:

    ```sh
    sudo netplan apply
    ```

4. Проверим разрешение имён с помощью `nslookup`.
